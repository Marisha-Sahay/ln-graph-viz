<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Graph Viz â€“ Interactive Network Visualization</title>
    
    <!-- Bitcoin Data Labs styles -->
    <link rel="stylesheet" href="https://sorukumar.github.io/Bitcoin-Data-Labs/styles/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Local styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Load dependencies in correct order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.26.0/graphology.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/graphology-library/dist/graphology-library.min.js"></script>
    <script src="https://unpkg.com/graphology-layout-forceatlas2@latest/dist/graphology-layout-forceatlas2.min.js"></script>
</head>
<body class="visualization-page">
    <!-- Bitcoin Data Labs Header -->
    <div id="header"></div>
    
    <div id="container">
        <div id="graph-container">
            <!-- Network Summary Title -->
            <div id="network-summary" class="network-summary">
                <h2 class="summary-title">
                    <i class="fas fa-bolt"></i> Lightning Network Graph Visualization
                </h2>
                <div class="summary-subtitle">
                    <span id="summary-nodes-count">0</span> nodes, <span id="summary-channels-count">0</span> channels
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div id="loading-indicator" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--surface); padding: 24px 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(42, 51, 66, 0.15); z-index: 2000; text-align: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary); margin-bottom: 12px;"></i>
                <div style="color: var(--text-primary); font-weight: 500;">Loading dataset...</div>
            </div>
            
            <div class="tooltip" id="tooltip"></div>
            <div class="controls">
                <button class="control-btn" id="zoom-in"><i class="fas fa-search-plus"></i> Zoom In</button>
                <button class="control-btn" id="zoom-out"><i class="fas fa-search-minus"></i> Zoom Out</button>
                <button class="control-btn" id="reset-view"><i class="fas fa-sync-alt"></i> Reset</button>
                <!-- <button class="control-btn" id="toggle-layout"><i class="fas fa-play"></i> Start Layout</button> -->
            </div>
            <!-- <div class="layout-hint" id="layout-hint">
                Click "Start Layout" multiple times to see patterns emerge
            </div> -->
        </div>
        <div id="sidebar">
            <!-- Dataset Switcher -->
            <div class="dataset-switcher">
                <label for="dataset-select" style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-database"></i>
                    Select Dataset
                    <div style="position: relative;">
                        <i class="fas fa-info-circle" id="dataset-info-icon" tabindex="0"></i>
                        <span id="dataset-tooltip" class="dataset-tooltip">Freeway: >1 BTC channel<br>Highway: >5M sats channel<br>Complete: All nodes</span>
                    </div>
                </label>
                <select id="dataset-select">
                    <option value="data/gfree.json" selected>Freeway Network</option>
                    <option value="data/ghigh.json">Highway Network</option>
                    <option value="data/gall.json">Complete Network</option>
                </select>
                <button id="load-dataset-btn">
                    <i class="fas fa-sync-alt"></i> Load Dataset
                </button>
            </div>
            
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Search nodes by name...">
            </div>
            
            <!-- Filters Section -->
            <div id="filters">
                <div class="filters-title" id="filters-toggle" style="cursor: pointer; user-select: none;">
                    <i class="fas fa-filter"></i> Filters
                    <i class="fas fa-chevron-down" id="filters-chevron" style="margin-left: auto; font-size: 12px;"></i>
                </div>
                
                <div id="filters-content" style="display: none;">
                    <div class="filter-section">
                        <div class="filter-label">
                            <i class="fas fa-trophy"></i> Pleb Rank (Top N)
                        </div>
                        <div class="filter-control">
                            <input type="range" id="pleb-rank-slider" min="0" max="10000" step="100" value="10000">
                            <div class="filter-value">
                                <span id="pleb-rank-value">All</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-label">
                            <i class="fas fa-bridge"></i> Node Bridges
                        </div>
                        <div class="filter-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="filter-all-nodes" checked>
                                <span>Show All Nodes</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="filter-important-bridge">
                                <span>Critical Bridge Only</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="filter-any-bridge">
                                <span>Any Bridge Only</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-label">
                            <i class="fas fa-link"></i> Channel Bridges
                        </div>
                        <div class="filter-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="filter-all-channels" checked>
                                <span>Show All Channels</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="filter-bridge-channels">
                                <span>Bridge Channels Only</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-btn" id="apply-filters">
                            <i class="fas fa-check"></i> Apply Filters
                        </button>
                        <button class="filter-btn secondary" id="clear-filters">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                    
                    <div id="filter-results" class="filter-results">
                        <span id="visible-count">0</span> / <span id="total-count">0</span> nodes visible
                    </div>
                </div>
            </div>
            
            <div id="node-info">
                <div class="info-title">Node Information</div>
                <div class="info-content">Select a node to see details</div>
            </div>
            <div id="edge-info">
                <div class="info-title">Channel Information</div>
                <div class="info-content">Select a channel to see details</div>
            </div>
        </div>
    </div>

    <!-- Bitcoin Data Labs Footer -->
    <div id="footer"></div>

    <!-- Bitcoin Data Labs App Components -->
    <script src="https://sorukumar.github.io/Bitcoin-Data-Labs/components/app-components.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            BitcoinLabsAppComponents.init({
                isApp: true,
                appName: "ln-graph-viz",
                appHomeUrl: "https://sorukumar.github.io/ln-graph-viz/"
            });
        });
    </script>

    <!-- Load visualization.js -->
    <script src="visualization.js"></script>
    
    <script>
        // Dataset configuration
        const DATASETS = {
            'data/gall.json': 'Complete Network',
            
            'data/gfree.json': 'Freeway',
            
            'data/ghigh.json': 'Highway',
            
        };

        // Get initial dataset from URL parameter or use default
        function getInitialDataset() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileParam = urlParams.get('file');
            
            // If URL has a valid file parameter, use it
            if (fileParam && DATASETS[fileParam]) {
                return fileParam;
            }
            
            // Default to Freeway Enhanced (new data)
            return 'data/gfree.json';
        }

        // Update URL using History API (no page reload)
        function updateURL(datasetPath) {
            const url = new URL(window.location);
            url.searchParams.set('file', datasetPath);
            window.history.pushState({ dataset: datasetPath }, '', url);
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // Load and display a dataset
        async function loadDataset(datasetPath) {
            // Prevent concurrent dataset loads
            if (window.isLoadingDataset) {
                console.log('â³ Already loading a dataset, please wait...');
                return;
            }
            
            window.isLoadingDataset = true;
            showLoading();
            
            try {
                console.log(`ðŸ“Š Loading dataset: ${datasetPath}`);
                
                // Destroy any existing visualization first
                if (typeof destroyVisualization === 'function') {
                    await destroyVisualization();
                }
                
                // Wait a moment to ensure cleanup is complete
                await new Promise(resolve => setTimeout(resolve, 150));
                
                // Load the new dataset
                await initVisualization(datasetPath);
                
                // Update URL
                updateURL(datasetPath);
                
                console.log('âœ… Dataset loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading dataset:', error);
                alert(`Failed to load dataset: ${error.message}`);
            } finally {
                window.isLoadingDataset = false;
                hideLoading();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const initialDataset = getInitialDataset();
            
            // Set the dropdown to match the initial dataset
            const datasetSelect = document.getElementById('dataset-select');
            datasetSelect.value = initialDataset;
            
            // Load the initial dataset
            loadDataset(initialDataset);
            
            // Set up load dataset button to reload page with new parameter (SIMPLE & RELIABLE)
            const loadDatasetBtn = document.getElementById('load-dataset-btn');
            loadDatasetBtn.addEventListener('click', () => {
                const selectedDataset = datasetSelect.value;
                // Simply reload the page with the new dataset parameter
                window.location.href = `?file=${selectedDataset}`;
            });

            // Toggle filters section
            const filtersToggle = document.getElementById('filters-toggle');
            const filtersContent = document.getElementById('filters-content');
            const filtersChevron = document.getElementById('filters-chevron');
            
            filtersToggle.addEventListener('click', () => {
                if (filtersContent.style.display === 'none') {
                    filtersContent.style.display = 'block';
                    filtersChevron.classList.remove('fa-chevron-down');
                    filtersChevron.classList.add('fa-chevron-up');
                } else {
                    filtersContent.style.display = 'none';
                    filtersChevron.classList.remove('fa-chevron-up');
                    filtersChevron.classList.add('fa-chevron-down');
                }
            });

            // Dataset tooltip
            const infoIcon = document.getElementById('dataset-info-icon');
            const tooltip = document.getElementById('dataset-tooltip');

            infoIcon.addEventListener('mouseenter', () => {
                tooltip.style.display = 'block';
            });

            infoIcon.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });

            infoIcon.addEventListener('focus', () => {
                tooltip.style.display = 'block';
            });

            infoIcon.addEventListener('blur', () => {
                tooltip.style.display = 'none';
            });
        });
    </script>
</body>
</html>